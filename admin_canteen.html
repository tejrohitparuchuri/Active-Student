<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin | Anurag University E-Canteen</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #0d0d0d;
            color: #ffffff;
            font-family: 'Inter', sans-serif;
        }

        .accent-orange {
            color: #ff9a2c;
        }

        .bg-accent-orange {
            background-color: #ff9a2c;
        }

        .card-dark {
            background-color: #1a1a1a;
            border: 1px solid #333;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .admin-border {
            border: 2px dashed #ff9a2c !important;
        }

        input,
        textarea {
            background: #222;
            border: 1px solid #444;
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            width: 100%;
            font-size: 0.875rem;
        }

        input:focus {
            border-color: #ff9a2c;
            outline: none;
        }

        .hidden {
            display: none;
        }

        .img-container {
            height: 160px;
            width: 100%;
            background: #262626;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .img-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    </style>
</head>

<body class="p-4 md:p-8">

    <nav class="flex justify-between items-center mb-12">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-orange-600 rounded shadow-[0_0_10px_rgba(249,115,22,0.5)]"></div>
            <h1 class="font-bold text-xl accent-orange">Anurag X Canteen</h1>
        </div>
        <div class="flex items-center gap-6">
            <a href="index.html"
                class="bg-zinc-800 hover:bg-zinc-700 px-3 py-2 rounded-lg text-xs font-bold transition-all border border-zinc-700 text-white">‚¨Ö
                Dashboard</a>
            <div class="hidden items-center gap-2 bg-zinc-800 px-3 py-1.5 rounded-full border border-zinc-700">
                <span class="text-xs font-bold text-gray-400">ADMIN MODE</span>
                <input type="checkbox" id="adminToggle" onclick="handleAdminToggle(event)"
                    class="w-4 h-4 accent-orange cursor-pointer">
            </div>
            <div class="bg-orange-500/10 px-4 py-2 rounded-full border border-orange-500/20">
                <span id="cart-count" class="font-bold accent-orange text-sm">Cart (0)</span>
            </div>
        </div>
    </nav>

    <header class="mb-16">
        <span
            class="bg-orange-500/10 text-orange-500 px-3 py-1 rounded-full text-xs font-semibold border border-orange-500/30">Management
            Dashboard</span>
        <h2 class="text-5xl font-extrabold mt-4 leading-tight">Canteen <span class="accent-orange">Control Center</span>
        </h2>
        <p class="text-gray-400 mt-4 max-w-xl">Admin: Paste an image URL below to update the visual menu. Changes
            reflect instantly for users.</p>
    </header>

    <!-- SCANNER SECTION -->
    <section class="max-w-2xl mx-auto mb-16 hidden" id="scanner-section">
        <div class="relative group">
            <div
                class="absolute -inset-1 bg-gradient-to-r from-orange-600 to-amber-600 rounded-2xl blur opacity-25 group-hover:opacity-50 transition duration-1000 group-hover:duration-200">
            </div>
            <div class="relative card-dark p-8 rounded-2xl flex flex-col items-center text-center space-y-6">
                <div
                    class="w-16 h-16 bg-zinc-800 rounded-full flex items-center justify-center border border-zinc-700 shadow-xl">
                    <span class="text-3xl">üì∑</span>
                </div>
                <div>
                    <h3 class="text-2xl font-bold text-white mb-2">Scan & Claim Order</h3>
                    <p class="text-gray-400 text-sm">Status will be updated to "Picked Up" instantly.</p>
                </div>

                <div class="flex w-full gap-2">
                    <input type="text" id="barcode-input" placeholder="Scan Barcode (e.g. ORD...)"
                        class="flex-1 bg-black border-2 border-zinc-700 focus:border-orange-500 rounded-xl px-4 py-3 text-lg font-mono text-center tracking-widest uppercase transition-all"
                        autocomplete="off" onkeypress="handleScan(event)">
                    <button onclick="processScan()"
                        class="bg-orange-600 hover:bg-orange-500 text-white font-bold px-6 rounded-xl transition-colors">CLAIM</button>
                </div>
                <div id="scan-result"
                    class="hidden w-full text-left bg-zinc-800/50 rounded-lg p-4 border border-zinc-700/50 transition-all">
                </div>
            </div>
        </div>
    </section>

    <section>
        <div class="flex justify-between items-center mb-8">
            <h3 class="text-2xl font-bold flex items-center gap-2">
                <span class="w-2 h-8 bg-accent-orange rounded"></span> Live Menu
            </h3>
            <button id="add-item-btn" onclick="addNewItem()"
                class="hidden bg-green-600 text-white px-6 py-2 rounded-lg text-sm font-bold shadow-lg hover:bg-green-500">+
                Add New Dish</button>
        </div>

        <div id="menu-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        </div>
    </section>

    <!-- Bill Modal (Restored) -->
    <div id="bill-modal" class="fixed inset-0 bg-black/95 hidden items-center justify-center p-4 z-50">
        <div class="bg-zinc-900 border border-zinc-700 p-8 rounded-2xl w-full max-w-md shadow-2xl">
            <h3 class="text-2xl font-bold accent-orange mb-4">Canteen Receipt</h3>
            <div id="bill-items" class="space-y-3 mb-6 text-gray-300 max-h-60 overflow-y-auto"></div>
            <div class="border-t border-zinc-800 pt-4">
                <div class="flex justify-between text-xl font-bold mb-6">
                    <span>Grand Total:</span>
                    <span id="bill-total" class="accent-orange">‚Çπ0</span>
                </div>
                <button onclick="closeBill()"
                    class="w-full bg-accent-orange text-black py-3 rounded-lg font-bold hover:bg-orange-400">Confirm
                    Purchase</button>
            </div>
        </div>
    </div>

    <!-- Checkout Button (Restored) -->
    <button id="checkout-btn" onclick="showBill()"
        class="fixed bottom-8 right-8 bg-accent-orange text-black px-8 py-4 rounded-full font-bold shadow-2xl hover:scale-105 transition-transform z-40">
        View Bill / Checkout
    </button>

    <!-- Float Scanner Button (Admin Only) -->
    <button id="float-scan-btn" onclick="scrollToScanner()"
        class="hidden fixed bottom-8 left-8 bg-zinc-800 text-white p-4 rounded-full font-bold shadow-2xl hover:scale-110 transition-transform z-40 border border-zinc-600">
        <span class="text-2xl">üì∑</span>
    </button>

    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 bg-black/90 hidden items-center justify-center p-4 z-50">
        <div class="bg-zinc-900 border border-zinc-700 p-8 rounded-2xl w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4 text-center">Admin Login</h3>
            <div class="space-y-4">
                <input type="email" id="admin-user" placeholder="Username"
                    class="w-full bg-zinc-800 border-zinc-600 rounded p-2">
                <input type="password" id="admin-pass" placeholder="Password"
                    class="w-full bg-zinc-800 border-zinc-600 rounded p-2">
                <div class="flex gap-2">
                    <button onclick="closeLoginModal()"
                        class="flex-1 bg-zinc-700 py-2 rounded font-bold text-sm">Cancel</button>
                    <button onclick="attemptLogin()"
                        class="flex-1 bg-accent-orange text-black py-2 rounded font-bold text-sm">Login</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, updateDoc, doc, query, where, getDocs, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDzvvkr99HGqS7LWg3_3wrquuo9mtVNPso",
            authDomain: "nrp-tejas26-cloudolog.firebaseapp.com",
            projectId: "nrp-tejas26-cloudolog",
            storageBucket: "nrp-tejas26-cloudolog.firebasestorage.app",
            messagingSenderId: "56277375228",
            appId: "1:56277375228:web:7ab38fad10b825329bdf79",
            measurementId: "G-WJQBB27LT6"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let menuItems = [];
        let cart = [];
        let isAdmin = false;

        onAuthStateChanged(auth, (user) => {
            if (user && user.email === 'canteen@anurag.edu.in') {
                isAdmin = true;
                // Update UI toggle to reflect state
                const checkbox = document.getElementById('adminToggle');
                if (checkbox) checkbox.checked = true;

                document.getElementById('add-item-btn').classList.remove('hidden');
                document.getElementById('checkout-btn').classList.add('hidden');
                renderMenu();
            }
        });

        // --- Real-time Menu Listener ---
        onSnapshot(collection(db, "canteen_menu"), (snapshot) => {
            menuItems = [];
            snapshot.forEach((doc) => {
                menuItems.push({ id: doc.id, ...doc.data() });
            });
            renderMenu();
        });

        function renderMenu() {
            const grid = document.getElementById('menu-grid');
            grid.innerHTML = '';

            menuItems.forEach((item) => {
                grid.innerHTML += `
                    <div class="card-dark rounded-xl ${isAdmin ? 'admin-border' : ''}">
                        <div class="img-container">
                            <img src="${item.img || 'https://via.placeholder.com/400x250?text=No+Image'}" 
                                 alt="${item.name}" 
                                 onerror="this.src='https://via.placeholder.com/400x250?text=Invalid+URL'">
                        </div>
                        
                        <div class="p-5">
                            ${isAdmin ? `
                                <div class="space-y-3">
                                    <div>
                                        <label class="text-[10px] text-orange-500 font-bold uppercase">Image URL</label>
                                        <input type="text" value="${item.img}" onchange="window.updateItem('${item.id}', 'img', this.value)" placeholder="https://image-link.com">
                                    </div>
                                    <div>
                                        <label class="text-[10px] text-orange-500 font-bold uppercase">Item Name</label>
                                        <input type="text" value="${item.name}" onchange="window.updateItem('${item.id}', 'name', this.value)">
                                    </div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label class="text-[10px] text-orange-500 font-bold uppercase">Price (‚Çπ)</label>
                                            <input type="number" value="${item.price}" onchange="window.updateItem('${item.id}', 'price', this.value)">
                                        </div>
                                        <div>
                                            <label class="text-[10px] text-orange-500 font-bold uppercase">Quantity Left</label>
                                            <input type="number" value="${item.stock !== undefined ? item.stock : 20}" onchange="window.updateItem('${item.id}', 'stock', this.value)">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="text-[10px] text-orange-500 font-bold uppercase">Description</label>
                                        <textarea rows="2" onchange="window.updateItem('${item.id}', 'desc', this.value)">${item.desc}</textarea>
                                    </div>
                                    <button onclick="window.deleteItem('${item.id}')" class="w-full bg-red-900/20 text-red-500 text-xs font-bold py-2 rounded hover:bg-red-900/40 transition-colors">Remove Item</button>
                                </div>
                            ` : `
                                <div class="flex justify-between items-start mb-2">
                                    <h4 class="font-bold text-lg mb-1">${item.name}</h4>
                                    ${item.stock !== undefined && item.stock < 10 ? `<span class="text-[10px] bg-red-500/20 text-red-500 px-2 py-0.5 rounded border border-red-500/30">Only ${item.stock} left</span>` : ''}
                                </div>
                                <p class="text-gray-400 text-sm mb-4 h-10 overflow-hidden line-clamp-2">${item.desc}</p>
                                <div class="flex justify-between items-center">
                                    <span class="accent-orange font-bold text-xl">‚Çπ${item.price}</span>
                                    <button onclick="window.addToCart('${item.name}', ${item.price})" class="bg-accent-orange text-black px-4 py-2 rounded-lg font-bold text-xs hover:bg-orange-400 transition-all active:scale-95">Add to Cart</button>
                                </div>
                            `}
                        </div>
                    </div>
                `;
            });
        }

        window.handleAdminToggle = function (e) {
            e.preventDefault(); // Prevent default toggle to handle logic manually
            const checkbox = document.getElementById('adminToggle');

            if (!checkbox.checked) {
                // Currently OFF, user wants to turn ON -> Show Login
                document.getElementById('login-modal').style.display = 'flex';
            } else {
                // Currently ON, user wants to turn OFF -> Allow immediately
                checkbox.checked = false;
                toggleAdminMode();
            }
        }

        window.closeLoginModal = function () {
            document.getElementById('login-modal').style.display = 'none';
            document.getElementById('admin-user').value = '';
            document.getElementById('admin-pass').value = '';
        }

        window.attemptLogin = async function () {
            const u = document.getElementById('admin-user').value;
            const p = document.getElementById('admin-pass').value;

            try {
                await signInWithEmailAndPassword(auth, u, p);

                // Double check email logic just to be safe, though Auth handled the password check
                if (auth.currentUser.email === "canteen@anurag.edu.in") {
                    document.getElementById('adminToggle').checked = true;
                    window.toggleAdminMode();
                    closeLoginModal();
                } else {
                    alert("Authorized, but not as Canteen Admin.");
                }
            } catch (e) {
                console.error(e);
                alert("Login Failed: " + e.message);
            }
        }

        window.toggleAdminMode = function () {
            isAdmin = document.getElementById('adminToggle').checked;
            document.getElementById('add-item-btn').classList.toggle('hidden', !isAdmin);
            document.getElementById('checkout-btn').classList.toggle('hidden', isAdmin);
            document.getElementById('scanner-section').classList.toggle('hidden', !isAdmin);
            document.getElementById('float-scan-btn').classList.toggle('hidden', !isAdmin);

            // Auto focus scanner if admin
            if (isAdmin) setTimeout(() => document.getElementById('barcode-input').focus(), 500);

            renderMenu();
        }

        window.scrollToScanner = function () {
            document.getElementById('scanner-section').scrollIntoView({ behavior: 'smooth', block: 'center' });
            document.getElementById('barcode-input').focus();
        }

        window.handleScan = function (e) {
            if (e.key === 'Enter') processScan();
        }

        window.processScan = async function () {
            const input = document.getElementById('barcode-input');
            const resultDiv = document.getElementById('scan-result');
            const val = input.value.trim().toUpperCase(); // Case insensitive ID matches

            if (!val) return;

            // Visual reset
            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = '<span class="text-yellow-500 font-mono animate-pulse">Searching Database...</span>';

            try {
                // 1. Find Order (Scan logic: assume input is orderId)
                const q = query(collection(db, "canteen_orders"), where("orderId", "==", val), limit(1));
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    resultDiv.innerHTML = `<div class="text-red-500 font-bold">‚ùå Order Not Found</div><div class="text-xs text-gray-500 mt-1">ID: ${val}</div>`;
                    // Don't clear input so they can fix it
                    return;
                }

                const orderDoc = snapshot.docs[0];
                const data = orderDoc.data();

                if (data.status === 'picked_up') {
                    resultDiv.innerHTML = `
                        <div class="flex items-center gap-3 text-yellow-500 border-l-4 border-yellow-500 pl-3">
                            <span class="text-2xl">‚ö†Ô∏è</span>
                            <div>
                                <div class="font-bold">Already Claimed</div>
                                <div class="text-xs text-gray-400">By ${data.userName} at ${data.updatedAt ? data.updatedAt.toDate().toLocaleTimeString() : 'Unknown'}</div>
                            </div>
                        </div>`;
                    input.value = ''; // Reset for next scan
                    return;
                }

                // 2. Claim Order
                await updateDoc(doc(db, "canteen_orders", orderDoc.id), {
                    status: 'picked_up',
                    updatedAt: new Date()
                });

                // 3. Success UI
                resultDiv.innerHTML = `
                    <div class="flex flex-col gap-2">
                         <div class="flex items-center gap-2 text-green-500 font-bold text-lg">
                            <span>‚úÖ ORDER CLAIMED</span>
                         </div>
                         <div class="bg-black/30 p-3 rounded text-sm space-y-1">
                             <div class="flex justify-between border-b border-white/10 pb-1 mb-1">
                                 <span class="text-gray-400">User</span>
                                 <span class="text-white font-bold">${data.userName}</span>
                             </div>
                             <div class="flex justify-between border-b border-white/10 pb-1 mb-1">
                                 <span class="text-gray-400">Total</span>
                                 <span class="text-accent-orange font-bold">‚Çπ${data.totalAmount.toFixed(2)}</span>
                             </div>
                             <div class="text-gray-400 text-xs italic mt-1">
                                 ${data.items.length} Items: ${data.items.map(i => i.qty + ' ' + i.name).join(', ')}
                             </div>
                         </div>
                    </div>
                `;

                // Play simplified beep sound (optional, using Web Audio API if browser allows, or just visual)

                input.value = ''; // Ready for next
                input.focus();

            } catch (e) {
                console.error(e);
                resultDiv.innerHTML = `<div class="text-red-500">Error: ${e.message}</div>`;
            }
        }

        window.updateItem = async function (id, field, value) {
            const val = (field === 'price' || field === 'stock') ? (parseFloat(value) || 0) : value;
            try {
                await updateDoc(doc(db, "canteen_menu", id), { [field]: val });
            } catch (e) { console.error('Error updating:', e); }
        }

        window.addNewItem = async function () {
            try {
                await addDoc(collection(db, "canteen_menu"), {
                    name: "New Dish",
                    price: 100,
                    stock: 50,
                    desc: "Delicious new addition.",
                    img: ""
                });
            } catch (e) {
                alert("Error adding item: " + e.message);
            }
        }

        window.deleteItem = async function (id) {
            if (confirm("Are you sure you want to delete this item?")) {
                try {
                    await deleteDoc(doc(db, "canteen_menu", id));
                } catch (e) { alert("Error deleting: " + e.message); }
            }
        }

        window.addToCart = function (name, price) {
            cart.push({ name, price });
            document.getElementById('cart-count').innerText = `Cart (${cart.length})`;
            const badge = document.getElementById('cart-count');
            badge.style.transform = "scale(1.2)";
            setTimeout(() => badge.style.transform = "scale(1)", 200);
        }

        window.showBill = function () {
            if (cart.length === 0) return alert("Your cart is empty!");

            const itemsContainer = document.getElementById('bill-items');
            const totalContainer = document.getElementById('bill-total');
            let subtotal = 0;

            itemsContainer.innerHTML = '';
            cart.forEach(item => {
                itemsContainer.innerHTML += `
                    <div class="flex justify-between border-b border-zinc-800 pb-2">
                        <span>${item.name}</span>
                        <span class="font-mono">‚Çπ${item.price}</span>
                    </div>`;
                subtotal += item.price;
            });

            const tax = subtotal * 0.05;
            itemsContainer.innerHTML += `
                <div class="flex justify-between text-sm text-zinc-500 pt-2 italic">
                    <span>GST (5%)</span>
                    <span>‚Çπ${tax.toFixed(2)}</span>
                </div>`;

            totalContainer.innerText = `‚Çπ${(subtotal + tax).toFixed(2)}`;
            document.getElementById('bill-modal').style.display = 'flex';
        }

        window.closeBill = function () {
            alert("Order Placed Successfully!");
            cart = [];
            document.getElementById('cart-count').innerText = `Cart (0)`;
            document.getElementById('bill-modal').style.display = 'none';
        }

    </script>
</body>

</html>